# diskmon

–û—Ç–ª–∏—á–Ω–æ! –í–æ—Ç **—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–¢–ó)** –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ —Å —è–¥—Ä–æ–º Linux, —Å —á–µ—Ç–∫–∏–º–∏ —à–∞–≥–∞–º–∏ –∏ —Ü–µ–ª—è–º–∏.  

---

## **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏—Å–∫–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (DiskMon)**  

### **1. –¶–µ–ª—å**  
–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å **–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ Go**, –∫–æ—Ç–æ—Ä—ã–π:  
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç **–¥–∏—Å–∫–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å, latency, –æ—à–∏–±–∫–∏).  
- –£–ø—Ä–∞–≤–ª—è–µ—Ç **IO-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏** –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —á–µ—Ä–µ–∑ **cgroups v2**.  
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **REST API** –∏ **gRPC** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (Kubernetes, Nomad).  

### **2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**  
1. **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** (—á–µ—Ä–µ–∑ eBPF, /proc/diskstats).  
2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ IO-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏** (—á–µ—Ä–µ–∑ cgroups).  
3. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π** (–≤—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, –æ—à–∏–±–∫–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞).  
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus/Grafana** (—ç–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫).  

---

## **3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**  

### **3.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**  
1. **–ê–≥–µ–Ω—Ç —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö** (eBPF + io_uring –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).  
2. **Cgroups Manager** (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `io.weight` –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤).  
3. **API-—Å–µ—Ä–≤–µ—Ä** (REST/gRPC).  
4. **–≠–∫—Å–ø–æ—Ä—Ç–µ—Ä –º–µ—Ç—Ä–∏–∫** (Prometheus).  

### **3.2 –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π**  
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç       | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏/–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏                          |  
|----------------|-----------------------------------------------|  
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**  | eBPF (libbpf, cilium/ebpf), io_uring          |  
| **Cgroups**     | `github.com/containerd/cgroups/v2`            |  
| **API**         | Gin (REST), gRPC (protobuf)                   |  
| **–ú–µ—Ç—Ä–∏–∫–∏**     | Prometheus Client (`github.com/prometheus/client_golang`) |  
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | Zerolog/Slog (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏)         |  

---

## **4. –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**  

### **–≠—Ç–∞–ø 1: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**  
**–¶–µ–ª—å:** –ü–æ–ª—É—á–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏, –∑–∞–¥–µ—Ä–∂–∫–∏, –æ—à–∏–±–∫–∏.  

**–®–∞–≥–∏:**  
1. **–ß—Ç–µ–Ω–∏–µ `/proc/diskstats`** (–±–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏).  
2. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—ã** —á–µ—Ä–µ–∑ `libbpf` (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ syscalls `read/write`).  
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ io_uring** –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.  
4. **–≠–∫—Å–ø–æ—Ä—Ç –≤ Prometheus** (–º–µ—Ç—Ä–∏–∫–∏: `disk_ops_total`, `disk_latency_ms`).  

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:**  
- `github.com/cilium/ebpf` (–æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è eBPF).  
- `github.com/prometheus/client_golang` (–º–µ—Ç—Ä–∏–∫–∏).  

---

### **–≠—Ç–∞–ø 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ IO —á–µ—Ä–µ–∑ cgroups v2**  
**–¶–µ–ª—å:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å IO –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.  

**–®–∞–≥–∏:**  
1. **–°–æ–∑–¥–∞–Ω–∏–µ cgroup** –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.  
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ `io.weight`** (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IO).  
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API** (REST-—ç–Ω–¥–ø–æ–∏–Ω—Ç `/limit_io`).  

**–ü—Ä–∏–º–µ—Ä API:**  
```http
POST /limit_io  
{ "pid": 1234, "io_weight": 50 }  
```

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:**  
- `github.com/containerd/cgroups/v2` (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cgroups).  

---

### **–≠—Ç–∞–ø 3: REST/gRPC API**  
**–¶–µ–ª—å:** –£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.  

**–®–∞–≥–∏:**  
1. **REST API** (Gin):  
   - `GET /metrics` ‚Äì —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏.  
   - `POST /limit_io` ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–æ–≤.  
2. **gRPC** (–¥–ª—è Kubernetes-–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤):  
   - `rpc GetDiskStats()` ‚Äì –ø–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ—Ç—Ä–∏–∫.  

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:**  
- `github.com/gin-gonic/gin` (REST).  
- `google.golang.org/grpc` (gRPC).  

---

### **–≠—Ç–∞–ø 4: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π**  
**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã.  

**–®–∞–≥–∏:**  
1. **–ê–Ω–∞–ª–∏–∑ –∑–∞–¥–µ—Ä–∂–µ–∫** (–µ—Å–ª–∏ `disk_latency_ms > 100ms` ‚Üí –∞–ª–µ—Ä—Ç).  
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Alertmanager** (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Slack/Telegram).  

---

## **5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**  
1. **Unit-—Ç–µ—Å—Ç—ã** (Mock eBPF, cgroups).  
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** (—Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∏—Å–∫–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏).  
3. **–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (fio + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).  

---

## **6. –†–µ–∑—É–ª—å—Ç–∞—Ç**  
- –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π **–º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∏—Å–∫–æ–≤—ã–º IO**.  
- –ì–æ—Ç–æ–≤—ã–π **Docker-–æ–±—Ä–∞–∑** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (Alpine + —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π Go-–±–∏–Ω–∞—Ä).  
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –ø–æ API –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é.  

---

### **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**  
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **LVM/ZFS**.  
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **Kubernetes Device Plugin**.  

---

–≠—Ç–æ –¢–ó –¥–∞–µ—Ç **—á–µ—Ç–∫–∏–π –ø–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ Linux. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –∫–∞–∫–æ–π-—Ç–æ —ç—Ç–∞–ø ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π! üöÄ
